<script>
const API = 'https://TU-APP.onrender.com/api'; // ← CAMBIA ESTO
const token = localStorage.getItem('admin_token');

if(!token){
  alert('Acceso no autorizado');
  location.href='login.html';
}

const headers = {
  'Content-Type':'application/json',
  'Authorization':'Bearer '+token
};

let currentUser = null;
let tvWidget = null;

// ================== CARGAR USUARIOS ==================
async function loadUsers(){
  try{
    const res = await fetch(API+'/admin/users',{headers});
    if(!res.ok) throw new Error('Error servidor');

    const users = await res.json();
    const list = document.getElementById('usersList');
    list.innerHTML = '';

    if(!users.length){
      list.innerHTML='<div style="color:#777">No hay usuarios</div>';
      return;
    }

    users.forEach(u=>{
      const div = document.createElement('div');
      div.innerHTML = `<strong>${u.email}</strong><br><span style="color:#777">Saldo: ${u.balance}</span>`;
      div.onclick = ()=> openUser(u);
      list.appendChild(div);
    });

  }catch(err){
    document.getElementById('usersList').innerHTML =
    `<div style="color:#b83a3a">Error conectando API</div>`;
    console.error(err);
  }
}

// ================== PERFIL ==================
function openUser(u){
  currentUser = u;

  document.getElementById('profilePanel').innerHTML = `
    <div class="card">
      <h2>${u.email}</h2>
      <p>ID: ${u._id}</p>
    </div>

    <div class="card">
      <label>Saldo (USDT)</label><br>
      <input id="balance" type="number" value="${u.balance}">
      <button class="primary" onclick="updateBalance()">Actualizar saldo</button>
    </div>

    <div class="card">
      <label>Apalancamiento</label><br>
      <select id="leverage">
        <option ${u.leverage==1?'selected':''}>1</option>
        <option ${u.leverage==5?'selected':''}>5</option>
        <option ${u.leverage==10?'selected':''}>10</option>
        <option ${u.leverage==20?'selected':''}>20</option>
        <option ${u.leverage==50?'selected':''}>50</option>
      </select>
      <button class="primary" onclick="updateLeverage()">Guardar leverage</button>
    </div>

    <div class="card">
      <label>Símbolo TradingView</label><br>
      <input id="symbolInput" value="BINANCE:BTCUSDT">
      <button class="primary" onclick="loadChart()">Cargar gráfico</button>
    </div>

    <div class="card">
      <div id="tv_chart" style="height:420px"></div>
    </div>

    <div class="card">
      <h3>Retiros pendientes</h3>
      <div id="withdraws">Cargando...</div>
    </div>
  `;

  loadWithdraws(u._id);
  setTimeout(loadChart,300);
}

// ================== TRADINGVIEW ==================
function loadChart(){
  const symbol = document.getElementById('symbolInput').value;

  if(tvWidget){
    tvWidget.remove();
  }

  tvWidget = new TradingView.widget({
    container_id:"tv_chart",
    symbol,
    interval:"15",
    timezone:"Etc/UTC",
    theme:"dark",
    style:"1",
    locale:"es",
    toolbar_bg:"#111",
    enable_publishing:false,
    allow_symbol_change:true,
    height:420
  });
}

// ================== UPDATE BALANCE ==================
async function updateBalance(){
  const balance = document.getElementById('balance').value;

  await fetch(API+'/admin/update-balance',{
    method:'POST',
    headers,
    body:JSON.stringify({userId:currentUser._id,balance})
  });

  alert('Saldo actualizado');
  loadUsers();
}

// ================== UPDATE LEVERAGE ==================
async function updateLeverage(){
  const leverage = document.getElementById('leverage').value;

  await fetch(API+'/admin/update-leverage',{
    method:'POST',
    headers,
    body:JSON.stringify({userId:currentUser._id,leverage})
  });

  alert('Apalancamiento actualizado');
  loadUsers();
}

// ================== RETIROS ==================
async function loadWithdraws(userId){
  const res = await fetch(API+'/admin/withdraws/'+userId,{headers});
  const data = await res.json();
  const box = document.getElementById('withdraws');
  box.innerHTML='';

  if(!data.length){
    box.innerHTML='<div style="color:#777">No hay solicitudes</div>';
    return;
  }

  data.forEach(w=>{
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`
      <p>Monto: ${w.amount}</p>
      <button class="primary" onclick="approveWithdraw('${w._id}')">Aprobar</button>
      <button class="danger" onclick="rejectWithdraw('${w._id}')">Rechazar</button>
    `;
    box.appendChild(div);
  });
}

async function approveWithdraw(id){
  await fetch(API+'/admin/withdraw/approve',{
    method:'POST',
    headers,
    body:JSON.stringify({id})
  });
  alert('Retiro aprobado');
  loadWithdraws(currentUser._id);
}

async function rejectWithdraw(id){
  await fetch(API+'/admin/withdraw/reject',{
    method:'POST',
    headers,
    body:JSON.stringify({id})
  });
  alert('Retiro rechazado');
  loadWithdraws(currentUser._id);
}

// INIT
loadUsers();
</script>
