<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äî Control Total</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- TradingView -->
<script src="https://s3.tradingview.com/tv.js"></script>

<style>
body{
  margin:0;
  font-family:Inter,system-ui,Arial;
  background:#0b0b0b;
  color:#eaeaea;
}
header{
  padding:16px;
  background:#111;
  border-bottom:1px solid #222;
  font-size:18px;
  font-weight:900;
  color:#d4af37;
}
.layout{
  display:grid;
  grid-template-columns:300px 1fr;
  height:calc(100vh - 60px);
}
.sidebar{
  border-right:1px solid #222;
  overflow:auto;
}
.sidebar div{
  padding:12px;
  cursor:pointer;
  border-bottom:1px solid #1a1a1a;
}
.sidebar div:hover{
  background:#151515;
}
.main{
  padding:20px;
  overflow:auto;
}
.card{
  background:#111;
  padding:16px;
  border-radius:10px;
  margin-bottom:16px;
}
input,select,button{
  background:#0f0f0f;
  color:#fff;
  border:1px solid #333;
  padding:8px;
  border-radius:6px;
}
button{
  cursor:pointer;
  font-weight:800;
}
.primary{background:#d4af37;color:#000}
.danger{background:#b83a3a}
label{font-size:13px;color:#aaa}
</style>
</head>

<body>

<header>üßë‚Äçüíº ADMINISTRACI√ìN ‚Äî CONTROL TOTAL</header>

<div class="layout">

<!-- LISTA DE CLIENTES -->
<div class="sidebar" id="usersList">
  <div style="color:#888">Cargando usuarios...</div>
</div>

<!-- PERFIL DEL CLIENTE -->
<div class="main" id="profilePanel">
  <div style="color:#777">Selecciona un cliente</div>
</div>

</div>

<script>
const API = 'http://localhost:3000/api';
const token = localStorage.getItem('admin_token');

if(!token){
  alert('Acceso no autorizado');
  location.href='login.html';
}

const headers = {
  'Content-Type':'application/json',
  'Authorization':'Bearer '+token
};

let currentUser = null;
let tvWidget = null;

// ================== CARGAR USUARIOS ==================
async function loadUsers(){
  const res = await fetch(API+'/admin/users',{headers});
  const users = await res.json();
  const list = document.getElementById('usersList');
  list.innerHTML = '';

  users.forEach(u=>{
    const div = document.createElement('div');
    div.innerHTML = `<strong>${u.email}</strong><br><span style="color:#777">Saldo: ${u.balance}</span>`;
    div.onclick = ()=> openUser(u);
    list.appendChild(div);
  });
}

// ================== PERFIL ADMIN DEL CLIENTE ==================
function openUser(u){
  currentUser = u;

  document.getElementById('profilePanel').innerHTML = `
    <div class="card">
      <h2>${u.email}</h2>
      <p>ID: ${u._id}</p>
    </div>

    <div class="card">
      <label>Saldo (USDT)</label><br>
      <input id="balance" type="number" value="${u.balance}">
      <button class="primary" onclick="updateBalance()">Actualizar saldo</button>
    </div>

    <div class="card">
      <label>Apalancamiento</label><br>
      <select id="leverage">
        <option ${u.leverage==1?'selected':''}>1</option>
        <option ${u.leverage==5?'selected':''}>5</option>
        <option ${u.leverage==10?'selected':''}>10</option>
        <option ${u.leverage==20?'selected':''}>20</option>
        <option ${u.leverage==50?'selected':''}>50</option>
      </select>
      <button class="primary" onclick="updateLeverage()">Guardar leverage</button>
    </div>

    <div class="card">
      <label>S√≠mbolo TradingView</label><br>
      <input id="symbolInput" value="BINANCE:BTCUSDT">
      <button class="primary" onclick="loadChart()">Cargar gr√°fico</button>
    </div>

    <div class="card">
      <div id="tv_chart" style="height:420px"></div>
    </div>

    <div class="card">
      <h3>Retiros pendientes</h3>
      <div id="withdraws">Cargando...</div>
    </div>
  `;

  loadWithdraws(u._id);
  setTimeout(loadChart,300);
}

// ================== TRADINGVIEW ==================
function loadChart(){
  const symbol = document.getElementById('symbolInput').value;

  if(tvWidget){
    tvWidget.remove();
  }

  tvWidget = new TradingView.widget({
    container_id: "tv_chart",
    symbol: symbol,
    interval: "15",
    timezone: "Etc/UTC",
    theme: "dark",
    style: "1",
    locale: "es",
    toolbar_bg: "#111",
    hide_top_toolbar: false,
    enable_publishing: false,
    allow_symbol_change: true,
    height: 420
  });
}

// ================== ACTUALIZAR SALDO ==================
async function updateBalance(){
  const balance = document.getElementById('balance').value;
  await fetch(API+'/admin/update-balance',{
    method:'POST',
    headers,
    body:JSON.stringify({userId:currentUser._id,balance})
  });
  alert('Saldo actualizado');
  loadUsers();
}

// ================== ACTUALIZAR LEVERAGE ==================
async function updateLeverage(){
  const leverage = document.getElementById('leverage').value;
  await fetch(API+'/admin/update-leverage',{
    method:'POST',
    headers,
    body:JSON.stringify({userId:currentUser._id,leverage})
  });
  alert('Apalancamiento actualizado');
  loadUsers();
}

// ================== RETIROS ==================
async function loadWithdraws(userId){
  const res = await fetch(API+'/admin/withdraws/'+userId,{headers});
  const data = await res.json();
  const box = document.getElementById('withdraws');
  box.innerHTML = '';

  if(data.length===0){
    box.innerHTML='<div style="color:#777">No hay solicitudes</div>';
    return;
  }

  data.forEach(w=>{
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML=`
      <p>Monto: ${w.amount}</p>
      <button class="primary" onclick="approveWithdraw('${w._id}')">Aprobar</button>
      <button class="danger" onclick="rejectWithdraw('${w._id}')">Rechazar</button>
    `;
    box.appendChild(div);
  });
}

async function approveWithdraw(id){
  await fetch(API+'/admin/withdraw/approve',{
    method:'POST',
    headers,
    body:JSON.stringify({id})
  });
  alert('Retiro aprobado');
  loadWithdraws(currentUser._id);
}

async function rejectWithdraw(id){
  await fetch(API+'/admin/withdraw/reject',{
    method:'POST',
    headers,
    body:JSON.stringify({id})
  });
  alert('Retiro rechazado');
  loadWithdraws(currentUser._id);
}

// INIT
loadUsers();
</script>

</body>
</html>
