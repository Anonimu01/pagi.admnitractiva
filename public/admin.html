<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äî Control Total</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://s3.tradingview.com/tv.js"></script>

<style>
body{
  margin:0;
  font-family:Inter,system-ui,Arial;
  background:#0b0b0b;
  color:#eaeaea;
}
header{
  padding:16px;
  background:#111;
  border-bottom:1px solid #222;
  font-size:18px;
  font-weight:900;
  color:#d4af37;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.logout{
  background:#b83a3a;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  color:white;
  cursor:pointer;
}
.layout{
  display:grid;
  grid-template-columns:300px 1fr;
  height:calc(100vh - 60px);
}
.sidebar{
  border-right:1px solid #222;
  overflow:auto;
}
.sidebar div{
  padding:12px;
  cursor:pointer;
  border-bottom:1px solid #1a1a1a;
}
.sidebar div:hover{
  background:#151515;
}
.main{
  padding:20px;
  overflow:auto;
}
.card{
  background:#111;
  padding:16px;
  border-radius:12px;
  margin-bottom:16px;
  box-shadow:0 0 0 1px #1c1c1c;
}
input,select,button{
  background:#0f0f0f;
  color:#fff;
  border:1px solid #333;
  padding:8px;
  border-radius:6px;
}
button{cursor:pointer;font-weight:800}
.primary{background:#d4af37;color:#000}
.danger{background:#b83a3a}
label{font-size:13px;color:#aaa}
.center{text-align:center;color:#777;margin-top:50px}
.loader{text-align:center;padding:30px;color:#888}
.error{color:#ff6b6b;text-align:center;margin-top:20px}
.small{font-size:12px;color:#999}
</style>
</head>

<body>

<header>
<span>üßë‚Äçüíº PANEL ADMINISTRACI√ìN</span>
<button class="logout" onclick="logout()">Cerrar sesi√≥n</button>
</header>

<div class="layout">

<div class="sidebar" id="usersList">
<div class="loader">Cargando usuarios...</div>
</div>

<div class="main" id="profilePanel">
<div class="center">Selecciona un usuario</div>
</div>

</div>

<script>

/* ================= API AUTO DETECT ================= */
/* Detecta si est√°s en Render (deploy) o en local y arma la base /api */
const API = location.hostname.includes("render.com")
  ? location.origin + "/api"
  : "http://localhost:4000/api";

/* ================= TOKEN (soporta admin_token o token) ================= */
/* Si no existe token redirige a login (no exponemos keys al frontend) */
const token = localStorage.getItem("admin_token") || localStorage.getItem("token");

if(!token){
  // si no hay token, redirige a login del panel admin
  location.href = "login.html";
}

/* headers din√°micos (s√≥lo a√±adimos Authorization si tenemos token) */
const headers = {
  "Content-Type": "application/json",
  ...(token ? { "Authorization": "Bearer " + token } : {})
};

let currentUser = null;
let tvWidget = null;

/* ================= safeFetch: manejo robusto de respuestas ================= */
async function safeFetch(url, options = {}){
  try{
    const opt = Object.assign({}, options);
    opt.headers = Object.assign({}, headers, options.headers || {});

    const res = await fetch(url, opt);

    // Si es 401 -> logout autom√°tico
    if(res.status === 401){
      logout();
      return null;
    }

    // Intentar parseo seguro; algunos endpoints devuelven 204 No Content
    if(res.status === 204) return {};

    let json = null;
    try {
      json = await res.json();
    } catch(parseErr){
      // si no es JSON devolvemos texto
      try{
        const txt = await res.text();
        return txt;
      }catch(e){
        return null;
      }
    }

    if(!res.ok){
      // si la API devuelve objeto con detalles, lo mostramos en consola y UI
      console.error('API error', res.status, json);
      // mostrar mensaje en panel principal si existe
      document.getElementById("profilePanel").innerHTML =
        `<div class="error">Error del servidor: ${json?.msg || res.statusText}</div>`;
      return null;
    }

    return json;

  }catch(e){
    console.error("Network error:", e);
    document.getElementById("profilePanel").innerHTML =
      `<div class="error">Error conectando al servidor</div>`;
    return null;
  }
}

/* ================= utilidad: extraer array de usuarios de respuestas variadas ================= */
function extractUsersFromResponse(resp){
  if(!resp) return null;
  if(Array.isArray(resp)) return resp;
  if(resp.users && Array.isArray(resp.users)) return resp.users;
  if(resp.data && Array.isArray(resp.data)) return resp.data;
  if(resp.result && Array.isArray(resp.result)) return resp.result;
  // si la respuesta misma tiene ok:true y users en otro nivel
  if(resp.ok && Array.isArray(resp.users)) return resp.users;
  return null;
}

/* ================= CARGAR USUARIOS ================= */
async function loadUsers(){

  const list = document.getElementById("usersList");
  list.innerHTML = '<div class="loader">Cargando...</div>';

  const resp = await safeFetch(API + "/admin/users", { headers });
  if(!resp) return;

  const users = extractUsersFromResponse(resp);
  if(!users){
    // Si la respuesta no tiene users, mostramos la estructura para debugging
    list.innerHTML = `<div class="error">Respuesta inesperada del servidor. Revisa la consola.</div>`;
    console.warn('Respuesta /admin/users:', resp);
    return;
  }

  list.innerHTML = "";

  if(users.length === 0){
    list.innerHTML = '<div class="center">No hay usuarios</div>';
    return;
  }

  users.forEach(u=>{
    const div = document.createElement("div");
    const bal = (typeof u.balance !== "undefined") ? u.balance : 0;
    const email = u.email || u.emailAddress || u.correo || "sin-email";
    div.innerHTML = `
      <strong class="small">${escapeHtml(email)}</strong><br>
      <span class="small">Saldo: ${escapeHtml(String(bal))}</span>
    `;
    div.onclick = ()=> openUser(u);
    list.appendChild(div);
  });
}

/* ================= ESCAPE HTML PARA PREVENIR XSS ================= */
function escapeHtml(s){
  return String(s || '').replace(/[&<>"']/g, function(m){
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
  });
}

/* ================= PERFIL ================= */
function openUser(u){

  currentUser = u;

  const userEmail = escapeHtml(u.email || u.emailAddress || u.correo || "");
  const userId = escapeHtml(u._id || u.id || "");
  const userBalance = typeof u.balance !== 'undefined' ? u.balance : 0;
  const userLeverage = typeof u.leverage !== 'undefined' ? u.leverage : 1;

  document.getElementById("profilePanel").innerHTML = `

<div class="card">
  <h2>${userEmail}</h2>
  <p class="small">ID: ${userId}</p>
</div>

<div class="card">
  <label>Saldo</label><br>
  <input id="balance" type="number" value="${escapeHtml(String(userBalance))}">
  <button class="primary" onclick="updateBalance()">Actualizar</button>
</div>

<div class="card">
  <label>Leverage</label><br>
  <select id="leverage">
    ${[1,5,10,20,50].map(n=>`<option value="${n}" ${Number(userLeverage)===Number(n)?"selected":""}>${n}</option>`).join("")}
  </select>
  <button class="primary" onclick="updateLeverage()">Guardar</button>
</div>

<div class="card">
  <label>S√≠mbolo gr√°fico</label><br>
  <input id="symbolInput" value="BINANCE:BTCUSDT">
  <button class="primary" onclick="loadChart()">Cargar gr√°fico</button>
</div>

<div class="card">
  <div id="tv_chart" style="height:420px"></div>
</div>

<div class="card">
  <h3>Retiros pendientes</h3>
  <div id="withdraws">Cargando...</div>
</div>
`;

  loadWithdraws(u._id || u.id);
  // carga el chart un poco despu√©s para asegurar que el contenedor exista
  setTimeout(loadChart, 300);
}

/* ================= CHART (TradingView) ================= */
function loadChart(){
  const symbolEl = document.getElementById("symbolInput");
  if(!symbolEl) return;
  const symbol = symbolEl.value || "BINANCE:BTCUSDT";

  // eliminar widget anterior si existe (TradingView provee 'remove' en algunos entornos)
  try{
    if(tvWidget && typeof tvWidget.remove === "function"){
      tvWidget.remove();
    } else if (tvWidget && tvWidget.container_id){
      const container = document.getElementById(tvWidget.container_id);
      if(container) container.innerHTML = '';
    }
  }catch(e){/* ignore */ }

  try{
    // inicializar TradingView
    tvWidget = new TradingView.widget({
      container_id: "tv_chart",
      symbol,
      interval: "15",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      locale: "es",
      toolbar_bg: "#111",
      enable_publishing: false,
      allow_symbol_change: true,
      height: 420
    });
  }catch(err){
    console.warn("TradingView init failed:", err);
    const chartBox = document.getElementById("tv_chart");
    if(chartBox) chartBox.innerHTML = `<div class="center">No se pudo cargar el gr√°fico</div>`;
  }
}

/* ================= ACTUALIZAR SALDO ================= */
async function updateBalance(){
  if(!currentUser) return;
  const balance = document.getElementById("balance").value;

  const resp = await safeFetch(API + "/admin/update-balance", {
    method: "POST",
    headers,
    body: JSON.stringify({
      userId: currentUser._id || currentUser.id,
      balance
    })
  });

  if(resp){
    // refrescar lista y seleccionar nuevamente al usuario (para ver cambios)
    await loadUsers();
    // intentar volver a seleccionar el usuario por id
    // (si el backend devuelve la lista actualizada, loadUsers la habr√° actualizado)
  }
}

/* ================= LEVERAGE ================= */
async function updateLeverage(){
  if(!currentUser) return;
  const leverage = document.getElementById("leverage").value;

  const resp = await safeFetch(API + "/admin/update-leverage", {
    method: "POST",
    headers,
    body: JSON.stringify({
      userId: currentUser._id || currentUser.id,
      leverage
    })
  });

  if(resp){
    await loadUsers();
  }
}

/* ================= RETIROS ================= */
async function loadWithdraws(id){

  const box = document.getElementById("withdraws");
  box.innerHTML = "Cargando...";

  const data = await safeFetch(API + "/admin/withdraws/" + encodeURIComponent(id), { headers });
  if(!data) return;

  // Si la respuesta contiene un objeto con 'withdraws' extraer la lista
  const list = Array.isArray(data) ? data : (data.withdraws || data.data || data.result || null);
  if(!list){
    box.innerHTML = '<span class="small">Respuesta inesperada del servidor</span>';
    console.warn('/admin/withdraws response', data);
    return;
  }

  box.innerHTML = "";

  if(list.length === 0){
    box.innerHTML = '<span style="color:#777">Sin solicitudes</span>';
    return;
  }

  list.forEach(w=>{
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <p>Monto: ${escapeHtml(String(w.amount || w.monto || 0))}</p>
      <button class="primary" onclick="approveWithdraw('${w._id || w.id}')">Aprobar</button>
      <button class="danger" onclick="rejectWithdraw('${w._id || w.id}')">Rechazar</button>
    `;
    box.appendChild(div);
  });
}

async function approveWithdraw(id){
  if(!id) return;
  const resp = await safeFetch(API + "/admin/withdraw/approve", {
    method: "POST",
    headers,
    body: JSON.stringify({ id })
  });
  if(resp) loadWithdraws(currentUser._id || currentUser.id);
}

async function rejectWithdraw(id){
  if(!id) return;
  const resp = await safeFetch(API + "/admin/withdraw/reject", {
    method: "POST",
    headers,
    body: JSON.stringify({ id })
  });
  if(resp) loadWithdraws(currentUser._id || currentUser.id);
}

/* ================= LOGOUT ================= */
function logout(){
  localStorage.removeItem("admin_token");
  // si existiera token normal de usuario, lo dejamos intacto solo si es necesario;
  // pero tambi√©n podemos remover 'token' si quieres cerrar sesi√≥n completamente:
  localStorage.removeItem("token");
  location.href = "login.html";
}

/* ================= INIT ================= */
loadUsers();

</script>

</body>
</html>
